name: Deploy Full Stack ðŸš€

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Backend + Frontend to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22

          script: |
            echo "ðŸ“‚ Loyihaga oâ€˜tyapman..."
            cd /root/mconsultwebsite

            echo "ðŸ“¥ Git pull..."
            git pull origin main

            echo "ðŸ”§ BACKEND DEPLOY"
            cd backend
            npm install
            npm run build
            pm2 start dist/main.js --name mconsult-backend --update-env || pm2 restart mconsult-backend --update-env

            echo "ðŸŽ¨ FRONTEND DEPLOY"
            cd ../frontend
            # Agar nginx root boshqacha boâ€˜lsa, nusxalash
            sudo cp -r * /var/www/mconsult/
            sudo nginx -t
            sudo systemctl reload nginx

            echo "âœ… FRONTEND + BACKEND DEPLOY TUGADI"
