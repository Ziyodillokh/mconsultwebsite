name: Deploy Full Stack ğŸš€

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Backend + Frontend to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22

          script: |
            echo "ğŸ“‚ Loyihaga o'tyapman..."
            cd /root/mconsultwebsite

            echo "ğŸ“¥ Git pull qilyapman..."
            git pull origin main

            echo "ğŸ”§ BACKEND DEPLOY"
            cd backend
            echo "  â”œâ”€ Dependencies o'rnatyapman..."
            npm install
            echo "  â”œâ”€ Build qilyapman..."
            npm run build
            echo "  â””â”€ PM2 restart..."
            pm2 restart mconsult-backend --update-env || pm2 start dist/main.js --name mconsult-backend

            echo "ğŸ¨ FRONTEND DEPLOY"
            cd ../frontend
            echo "  â”œâ”€ Fayllarni /var/www/magzunaconsult ga ko'chiryapman..."
            sudo cp -r * /var/www/magzunaconsult/
            echo "  â”œâ”€ Ruxsatlarni sozlayapman..."
            sudo chown -R www-data:www-data /var/www/magzunaconsult
            sudo chmod -R 755 /var/www/magzunaconsult
            echo "  â”œâ”€ Nginx test..."
            sudo nginx -t
            echo "  â””â”€ Nginx reload..."
            sudo systemctl reload nginx

            echo "âœ… DEPLOY MUVAFFAQIYATLI TUGADI!"
            echo "ğŸŒ Sayt: https://magzunaconsult.uz"

            echo "ğŸ“Š Status:"
            pm2 status mconsult-backend
